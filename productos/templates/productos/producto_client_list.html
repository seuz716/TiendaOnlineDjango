{% extends 'base.html' %}

{% block title %}Catálogo de Productos{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Filtros Avanzados -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-3 align-items-center">
                        <span class="fw-bold">Filtrar por:</span>
                        <!-- Filtro de Precio -->
                        <select name="priceFilter" class="form-select form-select-sm" style="max-width: 200px" id="priceFilter">
                            <option value="" {% if not request.GET.priceFilter %}selected{% endif %}>Precio</option>
                            <option value="asc" {% if request.GET.priceFilter == 'asc' %}selected{% endif %}>Menor a Mayor</option>
                            <option value="desc" {% if request.GET.priceFilter == 'desc' %}selected{% endif %}>Mayor a Menor</option>
                        </select>
                        <div class="vr"></div>
                        <!-- Dropdown para Categorías -->
                        <div class="dropdown">
                            <button class="btn btn-secondary dropdown-toggle" type="button" id="categoriaDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                {% if request.GET.categoria %}
                                    {% for categoria in categorias %}
                                        {% if categoria.slug == request.GET.categoria %}
                                            {{ categoria.nombre }}
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    Filtrar por Categoría
                                {% endif %}
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="categoriaDropdown">
                                <li>
                                    <a class="dropdown-item {% if not request.GET.categoria %}active{% endif %} categoria-link" 
                                       href="?{% if request.GET.priceFilter %}priceFilter={{ request.GET.priceFilter }}{% endif %}">
                                        Todas las Categorías
                                    </a>
                                </li>
                                {% for categoria in categorias %}
                                <li>
                                    <a class="dropdown-item categoria-link {% if categoria.slug == request.GET.categoria %}active{% endif %}" 
                                       href="?categoria={{ categoria.slug }}{% if request.GET.priceFilter %}&priceFilter={{ request.GET.priceFilter }}{% endif %}">
                                        {{ categoria.nombre }}
                                    </a>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div><!-- /.d-flex -->
                </div><!-- /.card-body -->
            </div><!-- /.card -->
        </div><!-- /.col-12 -->
    </div><!-- /.row -->

    <!-- Grid de Productos -->
    <!-- Este contenedor se actualizará dinámicamente con los resultados del filtro -->
    <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-4" id="productGrid">
        {% include 'productos/_product_grid.html' with productos=productos %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const priceFilter = document.getElementById('priceFilter');
    // Se seleccionan los enlaces del dropdown que tengan la clase "categoria-link"
    const categoriaLinks = document.querySelectorAll('.categoria-link');
    const productGrid = document.getElementById('productGrid');

    // Función que junta los parámetros actuales y realiza la petición AJAX
    function applyFilters() {
        // Se obtienen los valores actuales de los filtros
        const params = new URLSearchParams(window.location.search);
        // Actualiza el parámetro del filtro de precio según el select
        params.set('priceFilter', priceFilter.value);

        // Se arma la URL de la vista AJAX (asegúrate de tener configurada la URL con el nombre 'filtrar_productos')
        const url = "{% url 'filtrar_productos' %}?" + params.toString();
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                productGrid.innerHTML = data.html;
                // Actualiza la URL del navegador sin recargar la página
                window.history.pushState({}, '', '?' + params.toString());
            });
    }

    // Cuando cambia el select de precio, se aplica el filtro
    priceFilter.addEventListener('change', applyFilters);

    // Si se hace clic en alguna categoría (en el dropdown), se actualizan los filtros
    categoriaLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            // Actualiza la URL en el navegador (manteniendo el filtro de precio)
            const urlObj = new URL(link.href, window.location.origin);
            const params = new URLSearchParams(urlObj.search);
            // Si ya se seleccionó un precio, lo conserva
            params.set('priceFilter', priceFilter.value);
            window.history.pushState({}, '', '?' + params.toString());
            // Aplica los filtros
            applyFilters();
        });
    });
});
</script>
{% endblock %}
